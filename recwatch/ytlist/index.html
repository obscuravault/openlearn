<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focused Video Session - Playlist Support</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .locked {
            cursor: not-allowed;
            opacity: 0.5;
        }
        #video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
            background: #000;
        }
        #player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        /* Floating Controls Overlay */
        #controls-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 20;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.2) 20%, transparent 40%);
            transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 1;
            pointer-events: auto;
        }
        #controls-overlay.hide-cursor {
            cursor: none;
        }
        .controls-hidden {
            opacity: 0 !important;
            pointer-events: none !important;
        }
        input[type="range"] {
            cursor: pointer;
        }
        /* Visual feedback for shortcuts */
        #feedback-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.5);
            border-radius: 50%;
            padding: 20px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 30;
        }
        /* Skip feedback indicator */
        #skip-feedback {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 24px;
            font-weight: bold;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 35;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 2px solid rgba(59, 130, 246, 0.5);
        }
        /* Ensure buttons are clickable */
        #controls-overlay button,
        #controls-overlay select,
        #controls-overlay input[type="range"] {
            pointer-events: auto;
            position: relative;
            z-index: 25;
        }
        /* Swipe indicator */
        .swipe-indicator {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            pointer-events: none;
            z-index: 36;
            border: 1px solid rgba(255,255,255,0.2);
        }
        /* Playlist Sidebar */
        #playlist-sidebar {
            transition: all 0.3s ease;
            max-height: 500px;
            overflow-y: auto;
        }
        #playlist-sidebar.collapsed {
            max-height: 60px;
            overflow: hidden;
        }
        .playlist-item {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .playlist-item:hover {
            background: rgba(59, 130, 246, 0.2);
        }
        .playlist-item.active {
            background: rgba(59, 130, 246, 0.3);
            border-left: 4px solid #3b82f6;
        }
        .progress-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: conic-gradient(#3b82f6 0deg, #1e293b 0deg);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .progress-circle-inner {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #0f172a;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
        .playlist-progress-bar {
            height: 8px;
            background: #1e293b;
            border-radius: 4px;
            overflow: hidden;
        }
        .playlist-progress-fill {
            height: 100%;
            background: #3b82f6;
            transition: width 0.3s ease;
        }
        /* Custom scrollbar */
        #playlist-sidebar::-webkit-scrollbar {
            width: 6px;
        }
        #playlist-sidebar::-webkit-scrollbar-track {
            background: #1e293b;
            border-radius: 3px;
        }
        #playlist-sidebar::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }
        #playlist-sidebar::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
    </style>
</head>
<body class="bg-slate-900 min-h-screen flex flex-col items-center p-4 md:p-8 text-slate-100 transition-all">

    <div class="max-w-7xl w-full bg-slate-800 rounded-2xl shadow-2xl p-6 md:p-10 border border-slate-700">
        <!-- Header -->
        <div class="mb-6 text-center" id="header-area">
            <h1 class="text-2xl font-bold text-white mb-2">Focused Learning Portal - Playlist Mode</h1>
            <p id="sub-header" class="text-slate-400 text-sm">Session progress is automatically saved to your browser cache.</p>
        </div>

        <!-- Input Section -->
        <div id="setup-section" class="space-y-4">
            <div class="flex flex-col gap-2">
                <label for="video-url" class="font-semibold text-slate-300">Enter YouTube URL or Playlist URL</label>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="video-url" placeholder="https://www.youtube.com/watch?v=... or paste playlist URL" 
                           class="flex-1 p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-white">
                    <button onclick="handleManualLoad()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-bold transition-all">
                        Load Session
                    </button>
                </div>
                <div class="flex gap-2 text-xs text-slate-500">
                    <span class="bg-slate-700 px-2 py-1 rounded">üé¨ Single Video</span>
                    <span class="bg-slate-700 px-2 py-1 rounded">üìã YouTube Playlist</span>
                    <span class="bg-slate-700 px-2 py-1 rounded">üîç Demo Playlist (Click)</span>
                </div>
                <p id="error-msg" class="text-red-400 text-sm hidden">Invalid URL or unable to load playlist.</p>
            </div>
            <div class="text-xs text-slate-500 bg-slate-900/50 p-3 rounded border border-slate-700">
                <strong>Shortcuts:</strong> [Space] Play/Pause ‚Ä¢ [‚Üê] [‚Üí] Skip 5s ‚Ä¢ [M] Mute ‚Ä¢ [F] Fullscreen ‚Ä¢ [N] Next Video ‚Ä¢ [P] Previous Video ‚Ä¢ [Double Tap Left/Right] Skip ‚Ä¢ [Swipe Left/Right] Skip
            </div>
        </div>

        <!-- Integrated Video Section with Playlist -->
        <div id="player-section" class="hidden space-y-6">
            <div class="flex flex-col lg:flex-row gap-6">
                <!-- Main Video Player -->
                <div class="lg:w-3/4">
                    <div id="video-container" class="rounded-xl overflow-hidden shadow-2xl border border-slate-700 group relative">
                        <div id="player"></div>
                        
                        <!-- Swipe Instruction (shows on mobile) -->
                        <div class="swipe-indicator md:hidden">‚Üê Swipe Left/Right to Skip ‚Üí</div>
                        
                        <!-- Interaction & Controls Layer -->
                        <div id="controls-overlay" 
                             onmouseenter="resetTimer(true)" 
                             onmousemove="resetTimer(false)" 
                             onmousedown="resetTimer(false)" 
                             onclick="handleOverlayClick(event)"
                             ontouchstart="handleTouchStart(event)"
                             ontouchmove="handleTouchMove(event)"
                             ontouchend="handleTouchEnd(event)">
                            
                            <!-- Feedback Center -->
                            <div id="feedback-indicator">
                                <svg id="feedback-icon" class="w-12 h-12 text-white fill-current" viewBox="0 0 24 24"></svg>
                            </div>
                            
                            <!-- Skip Feedback -->
                            <div id="skip-feedback">
                                <svg class="w-6 h-6 fill-current" viewBox="0 0 24 24">
                                    <path id="skip-icon-path" d="M11 18V6l-8.5 6 8.5 6zm.5-6l8.5 6V6l-8.5 6z"/>
                                </svg>
                                <span id="skip-text">-5s</span>
                            </div>

                            <!-- Bottom Bar -->
                            <div class="p-4 w-full flex flex-col gap-3">
                                <!-- Progress Bar (Integrated) -->
                                <div class="relative w-full h-1.5 bg-white/20 rounded-full overflow-hidden">
                                    <div id="progress-bar" class="absolute top-0 left-0 bg-blue-500 h-full w-0 transition-all duration-300"></div>
                                </div>

                                <div class="flex items-center justify-between">
                                    <!-- Left: Play/Mute/Time -->
                                    <div class="flex items-center gap-4">
                                        <button onclick="togglePlay(); event.stopPropagation();" class="text-white hover:scale-110 transition-transform">
                                            <svg id="play-icon" class="w-7 h-7 fill-current" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                            <svg id="pause-icon" class="w-7 h-7 fill-current hidden" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                                        </button>

                                        <div class="flex items-center gap-2">
                                            <button onclick="toggleMute(); event.stopPropagation();" class="text-white/80 hover:text-white">
                                                <svg id="vol-icon" class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                                                <svg id="mute-icon" class="w-5 h-5 fill-current hidden" viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>
                                            </button>
                                            <input type="range" id="volume-slider" min="0" max="100" value="100" 
                                                   oninput="changeVolume(this.value); event.stopPropagation();"
                                                   class="w-16 h-1 bg-white/20 rounded-lg appearance-none accent-white">
                                        </div>
                                        <span id="time-display" class="text-[10px] font-mono text-white/60">0:00 / 0:00</span>
                                    </div>

                                    <!-- Center: Video Title -->
                                    <div id="current-video-title" class="hidden md:block text-sm text-white/80 truncate max-w-xs">
                                        Loading...
                                    </div>

                                    <!-- Right: Speed/FS -->
                                    <div class="flex items-center gap-4">
                                        <select id="speed-control" onchange="changeSpeed(this.value); event.stopPropagation();" 
                                                class="bg-transparent text-xs font-bold text-white border-none outline-none cursor-pointer">
                                            <option class="text-black" value="0.5">0.5x</option>
                                            <option class="text-black" value="1" selected>1.0x</option>
                                            <option class="text-black" value="1.5">1.5x</option>
                                            <option class="text-black" value="2.0">2.0x</option>
                                        </select>
                                        <button onclick="toggleFullscreen(); event.stopPropagation();" class="text-white/80 hover:text-white">
                                            <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Playlist Progress Summary (Mobile) -->
                    <div id="playlist-summary-mobile" class="mt-4 lg:hidden bg-slate-700/50 p-4 rounded-xl border border-slate-600">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-sm">Playlist Progress</span>
                            <span id="playlist-percent-mobile" class="text-blue-400 font-bold">0%</span>
                        </div>
                        <div class="playlist-progress-bar">
                            <div id="playlist-progress-fill-mobile" class="playlist-progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Playlist Sidebar -->
                <div id="playlist-sidebar" class="lg:w-1/4 bg-slate-700/30 rounded-xl border border-slate-600 p-4">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-2">
                            <svg class="w-5 h-5 fill-current text-blue-400" viewBox="0 0 24 24">
                                <path d="M4 6h16v2H4V6zm2-4h12v2H6V2zm16 8v10H2V10h20zm-2 2H4v6h16v-6z"/>
                            </svg>
                            <h3 class="font-bold text-lg">Playlist</h3>
                        </div>
                        <button onclick="togglePlaylist()" class="text-slate-400 hover:text-white transition-colors">
                            <svg id="collapse-icon" class="w-5 h-5 fill-current" viewBox="0 0 24 24">
                                <path d="M7 10l5 5 5-5H7z"/>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Playlist Stats -->
                    <div class="mb-4 p-3 bg-slate-800/50 rounded-lg">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-slate-400">Videos</span>
                            <span id="playlist-count" class="font-bold text-white">0/0</span>
                        </div>
                        <div class="flex justify-between text-xs mb-2">
                            <span class="text-slate-400">Completed</span>
                            <span id="playlist-percent" class="font-bold text-blue-400">0%</span>
                        </div>
                        <div class="playlist-progress-bar">
                            <div id="playlist-progress-fill" class="playlist-progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- Playlist Items Container -->
                    <div id="playlist-items" class="space-y-2 max-h-96 overflow-y-auto pr-1">
                        <!-- Playlist items will be injected here -->
                        <div class="text-center text-slate-500 py-8">No playlist loaded</div>
                    </div>
                    
                    <!-- Playlist Navigation Buttons -->
                    <div class="flex gap-2 mt-4 pt-3 border-t border-slate-600">
                        <button onclick="previousVideo()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-2 px-3 rounded-lg text-sm font-bold transition-colors flex items-center justify-center gap-1">
                            <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24">
                                <path d="M6 6h2v12H6V6zm3.5 6l8.5 6V6l-8.5 6z"/>
                            </svg>
                            Previous
                        </button>
                        <button onclick="nextVideo()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded-lg text-sm font-bold transition-colors flex items-center justify-center gap-1">
                            Next
                            <svg class="w-4 h-4 fill-current" viewBox="0 0 24 24">
                                <path d="M18 6v12h-2V6h2zm-3.5 6l-8.5-6v12l8.5-6z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Lock Status -->
            <div class="flex flex-col items-center gap-4 mt-4">
                <div class="flex justify-between w-full text-xs font-bold uppercase tracking-widest text-slate-500">
                    <span id="status-text">üîí Session Locked</span>
                    <span id="percent-text">0% Complete</span>
                </div>
                <button id="close-btn" disabled 
                        class="locked w-full py-4 bg-slate-700 text-slate-500 font-bold rounded-xl text-lg uppercase tracking-wider transition-all">
                    Complete Playlist to Unlock
                </button>
                <button onclick="resetApp()" class="text-xs text-slate-500 hover:text-slate-300 underline transition-colors">
                    Switch Video / Start New Session
                </button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 bg-slate-950/95 backdrop-blur-md hidden items-center justify-center p-4 z-50">
        <div class="bg-slate-800 p-8 rounded-2xl max-sm w-full text-center shadow-2xl border border-slate-700">
            <div class="w-20 h-20 bg-green-500/20 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl">‚úì</div>
            <h2 class="text-2xl font-bold mb-2">Congratulations!</h2>
            <p class="text-slate-400 mb-6 text-sm">You've completed the entire playlist! Session cleared from cache.</p>
            <button onclick="resetApp()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold">Start New Session</button>
        </div>
    </div>

    <script>
        let player;
        let progressInterval;
        let isComplete = false;
        let hideTimeout;
        let lastTap = 0;
        let currentVideoId = "";
        let playlistId = "";
        let playlistItems = [];
        let currentIndex = 0;
        let isPlaylist = false;
        
        // Touch gesture variables
        let touchStartX = 0;
        let touchEndX = 0;
        const MIN_SWIPE_DISTANCE = 50;

        const icons = {
            play: "M8 5v14l11-7z",
            pause: "M6 19h4V5H6v14zm8-14v14h4V5h-4z",
            mute: "M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z",
            vol: "M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z",
            skipBack: "M11 18V6l-8.5 6 8.5 6zm.5-6l8.5 6V6l-8.5 6z",
            skipForward: "M13 6v12l8.5-6L13 6zm-1.5 6l-8.5 6V6l8.5 6z"
        };

        // Demo Playlists
        const DEMO_PLAYLISTS = {
            'javascript': [
                { id: 'W6NZfCO5SIk', title: 'JavaScript Tutorial for Beginners', duration: '12:34', progress: 0, completed: false },
                { id: 'hdI2bqOjy3c', title: 'JavaScript Crash Course', duration: '15:20', progress: 0, completed: false },
                { id: 'PkZNo7MFNFg', title: 'Learn JavaScript - Full Course', duration: '20:15', progress: 0, completed: false }
            ],
            'webdev': [
                { id: 'UB1O30fR-EE', title: 'HTML & CSS Full Course', duration: '11:45', progress: 0, completed: false },
                { id: '1Rs2ND1ryYc', title: 'CSS Tutorial - Zero to Hero', duration: '14:30', progress: 0, completed: false },
                { id: 'T-uplIhw3jg', title: 'Responsive Web Design', duration: '18:20', progress: 0, completed: false }
            ],
            'python': [
                { id: 'rfscVS0vtbw', title: 'Python Tutorial for Beginners', duration: '13:25', progress: 0, completed: false },
                { id: 'YYXdXT2l-Gg', title: 'Python Crash Course', duration: '16:40', progress: 0, completed: false },
                { id: 'rZ41y93P2Qo', title: 'Python for Everybody', duration: '22:10', progress: 0, completed: false }
            ]
        };

        // --- Playlist Functions ---

        function extractPlaylistId(url) {
            // Check for YouTube playlist URL
            const match = url.match(/[&?]list=([^&]+)/);
            if (match) return match[1];
            
            // Check for demo playlist
            if (url.toLowerCase().includes('javascript')) return 'javascript';
            if (url.toLowerCase().includes('webdev')) return 'webdev';
            if (url.toLowerCase().includes('python')) return 'python';
            
            return null;
        }

        function loadDemoPlaylist(playlistId) {
            isPlaylist = true;
            playlistItems = JSON.parse(JSON.stringify(DEMO_PLAYLISTS[playlistId] || DEMO_PLAYLISTS.javascript));
            
            // Load saved progress
            loadPlaylistProgress();
            
            currentIndex = 0;
            renderPlaylist();
            updatePlaylistStats();
            
            // Load first video
            loadVideo(playlistItems[0].id);
        }

        function loadPlaylistFromUrls(videoIds) {
            isPlaylist = true;
            playlistItems = videoIds.map((id, index) => ({
                id: id,
                title: `Video ${index + 1}`,
                duration: '0:00',
                progress: 0,
                completed: false
            }));
            
            // Try to get titles from YouTube API if available
            // For now, we'll use placeholder titles
            
            loadPlaylistProgress();
            currentIndex = 0;
            renderPlaylist();
            updatePlaylistStats();
            loadVideo(playlistItems[0].id);
        }

        function loadPlaylistProgress() {
            const saved = localStorage.getItem(`playlist_progress_${playlistId || 'default'}`);
            if (saved) {
                try {
                    const progress = JSON.parse(saved);
                    playlistItems = playlistItems.map((video, index) => {
                        if (progress[index]) {
                            return {
                                ...video,
                                progress: progress[index].progress || 0,
                                completed: progress[index].completed || false
                            };
                        }
                        return video;
                    });
                    
                    // Find last played video (first incomplete with progress > 0)
                    const lastPlayedIndex = playlistItems.findIndex(v => v.progress > 0 && !v.completed);
                    if (lastPlayedIndex !== -1) {
                        currentIndex = lastPlayedIndex;
                    }
                } catch (e) {
                    console.error('Error loading playlist progress', e);
                }
            }
        }

        function savePlaylistProgress() {
            const progress = playlistItems.map(v => ({
                progress: v.progress,
                completed: v.completed
            }));
            localStorage.setItem(`playlist_progress_${playlistId || 'default'}`, JSON.stringify(progress));
        }

        function renderPlaylist() {
            const container = document.getElementById('playlist-items');
            if (!container) return;
            
            if (playlistItems.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 py-8">No videos in playlist</div>';
                return;
            }
            
            let html = '';
            playlistItems.forEach((video, index) => {
                const isActive = index === currentIndex;
                const progressPercent = Math.floor(video.progress);
                const progressDeg = progressPercent * 3.6;
                
                html += `
                    <div class="playlist-item p-3 rounded-lg ${isActive ? 'active bg-blue-900/30 border-l-4 border-blue-500' : 'bg-slate-800/30'} flex items-start gap-3" 
                         onclick="selectVideo(${index})">
                        <div class="flex-shrink-0 relative">
                            <div class="progress-circle" style="background: conic-gradient(#3b82f6 ${progressDeg}deg, #1e293b ${progressDeg}deg)">
                                <div class="progress-circle-inner">
                                    ${video.completed ? '‚úì' : (progressPercent > 0 ? progressPercent + '%' : '0%')}
                                </div>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="font-medium text-sm truncate ${isActive ? 'text-blue-400' : 'text-white'}">${video.title}</div>
                            <div class="flex justify-between text-xs mt-1">
                                <span class="text-slate-400">${video.duration}</span>
                                ${video.completed ? 
                                    '<span class="text-green-400">‚úì Completed</span>' : 
                                    `<span class="text-blue-400">${progressPercent}%</span>`
                                }
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updatePlaylistStats() {
            const completed = playlistItems.filter(v => v.completed).length;
            const total = playlistItems.length;
            const percent = total > 0 ? Math.floor((completed / total) * 100) : 0;
            
            document.getElementById('playlist-count').innerText = `${completed}/${total}`;
            document.getElementById('playlist-percent').innerText = `${percent}%`;
            document.getElementById('playlist-percent-mobile').innerText = `${percent}%`;
            document.getElementById('playlist-progress-fill').style.width = `${percent}%`;
            document.getElementById('playlist-progress-fill-mobile').style.width = `${percent}%`;
            
            // Check if playlist is complete
            if (completed === total && total > 0 && !isComplete) {
                completeSession();
            }
        }

        function updateVideoProgress(videoId, progressPercent, completed = false) {
            const index = playlistItems.findIndex(v => v.id === videoId);
            if (index !== -1) {
                playlistItems[index].progress = progressPercent;
                if (completed || progressPercent >= 95) {
                    playlistItems[index].completed = true;
                    playlistItems[index].progress = 100;
                }
                renderPlaylist();
                updatePlaylistStats();
                savePlaylistProgress();
            }
        }

        function selectVideo(index) {
            if (index >= 0 && index < playlistItems.length) {
                currentIndex = index;
                const video = playlistItems[index];
                loadVideo(video.id);
                renderPlaylist();
            }
        }

        function nextVideo() {
            if (currentIndex < playlistItems.length - 1) {
                selectVideo(currentIndex + 1);
            }
        }

        function previousVideo() {
            if (currentIndex > 0) {
                selectVideo(currentIndex - 1);
            }
        }

        function togglePlaylist() {
            const sidebar = document.getElementById('playlist-sidebar');
            const icon = document.getElementById('collapse-icon');
            sidebar.classList.toggle('collapsed');
            
            if (sidebar.classList.contains('collapsed')) {
                icon.style.transform = 'rotate(180deg)';
            } else {
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // --- Core Lifecycle ---

        window.onload = function() {
            const lastSessionId = localStorage.getItem('active_video_id');
            const lastPlaylistId = localStorage.getItem('active_playlist_id');
            
            if (lastPlaylistId) {
                playlistId = lastPlaylistId;
                loadDemoPlaylist(lastPlaylistId);
            } else if (lastSessionId) {
                loadVideo(lastSessionId);
            }
            
            // Add hover detection for the video container
            const videoContainer = document.getElementById('video-container');
            const overlay = document.getElementById('controls-overlay');
            
            if (videoContainer) {
                videoContainer.addEventListener('mouseenter', () => {
                    resetTimer(true);
                });
                
                videoContainer.addEventListener('mouseleave', () => {
                    if (player && typeof player.getPlayerState === 'function') {
                        const state = player.getPlayerState();
                        if (state === YT.PlayerState.PLAYING) {
                            overlay.classList.add('controls-hidden', 'hide-cursor');
                        }
                    }
                });
            }
        };

        function resetTimer(forceShow = false) {
            const overlay = document.getElementById('controls-overlay');
            if(!overlay) return;
            
            overlay.classList.remove('controls-hidden', 'hide-cursor');
            clearTimeout(hideTimeout);
            
            if (!forceShow) {
                if (player && typeof player.getPlayerState === 'function') {
                    const state = player.getPlayerState();
                    if (state === YT.PlayerState.PLAYING) {
                        hideTimeout = setTimeout(() => {
                            const videoContainer = document.getElementById('video-container');
                            if (videoContainer && !videoContainer.matches(':hover')) {
                                overlay.classList.add('controls-hidden', 'hide-cursor');
                            }
                        }, 3000);
                    }
                }
            }
        }

        window.onbeforeunload = () => {
            if (!isComplete && player && typeof player.getPlayerState === 'function') {
                return "Your progress is saved, but you haven't finished the playlist!";
            }
            return null;
        };

        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function extractVideoId(url) {
            const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function handleManualLoad() {
            const url = document.getElementById('video-url').value.trim();
            document.getElementById('error-msg').classList.add('hidden');
            
            // Check for demo keywords
            if (url.toLowerCase() === 'demo' || url.toLowerCase() === 'javascript') {
                playlistId = 'javascript';
                loadDemoPlaylist('javascript');
                localStorage.setItem('active_playlist_id', 'javascript');
                localStorage.removeItem('active_video_id');
                return;
            }
            
            if (url.toLowerCase() === 'webdev') {
                playlistId = 'webdev';
                loadDemoPlaylist('webdev');
                localStorage.setItem('active_playlist_id', 'webdev');
                localStorage.removeItem('active_video_id');
                return;
            }
            
            if (url.toLowerCase() === 'python') {
                playlistId = 'python';
                loadDemoPlaylist('python');
                localStorage.setItem('active_playlist_id', 'python');
                localStorage.removeItem('active_video_id');
                return;
            }
            
            // Check if it's a playlist URL
            const extractedPlaylistId = extractPlaylistId(url);
            if (extractedPlaylistId) {
                if (DEMO_PLAYLISTS[extractedPlaylistId]) {
                    playlistId = extractedPlaylistId;
                    loadDemoPlaylist(extractedPlaylistId);
                    localStorage.setItem('active_playlist_id', extractedPlaylistId);
                    localStorage.removeItem('active_video_id');
                } else {
                    // For real YouTube playlists, load demo playlist with message
                    alert('YouTube API key required for real playlists. Loading demo playlist instead.');
                    playlistId = 'javascript';
                    loadDemoPlaylist('javascript');
                    localStorage.setItem('active_playlist_id', 'javascript');
                    localStorage.removeItem('active_video_id');
                }
                return;
            }
            
            // Check if it's a single video
            const videoId = extractVideoId(url);
            if (videoId) {
                isPlaylist = false;
                playlistItems = [];
                playlistId = '';
                localStorage.removeItem('active_playlist_id');
                loadVideo(videoId);
                return;
            }
            
            // If all else fails, show error
            document.getElementById('error-msg').classList.remove('hidden');
        }

        function loadVideo(videoId) {
            currentVideoId = videoId;
            
            document.getElementById('setup-section').classList.add('hidden');
            document.getElementById('player-section').classList.remove('hidden');
            document.getElementById('sub-header').innerText = isPlaylist ? "Loading playlist..." : "Resuming your saved session...";

            const savedSeconds = localStorage.getItem(`video_progress_${currentVideoId}`) || 0;
            
            if (!isPlaylist) {
                localStorage.setItem('active_video_id', currentVideoId);
            }

            if (player && typeof player.loadVideoById === 'function') {
                player.loadVideoById({
                    videoId: videoId,
                    startSeconds: Math.floor(savedSeconds)
                });
            } else {
                player = new YT.Player('player', {
                    height: '360', 
                    width: '640', 
                    videoId: videoId,
                    playerVars: { 
                        'autoplay': 1, 
                        'controls': 0, 
                        'disablekb': 1, 
                        'modestbranding': 1, 
                        'rel': 0, 
                        'iv_load_policy': 3, 
                        'fs': 0,
                        'start': Math.floor(savedSeconds)
                    },
                    events: { 
                        'onReady': onPlayerReady, 
                        'onStateChange': onPlayerStateChange 
                    }
                });
            }
        }

        function onPlayerReady() {
            startTracking();
            resetTimer(true);
            
            // Try to get video title
            if (player && player.getVideoData) {
                const videoData = player.getVideoData();
                document.getElementById('current-video-title').innerText = videoData.title || 'Now Playing';
                
                // Update playlist item title if needed
                if (isPlaylist) {
                    const index = playlistItems.findIndex(v => v.id === currentVideoId);
                    if (index !== -1 && videoData.title) {
                        playlistItems[index].title = videoData.title;
                        renderPlaylist();
                    }
                }
            }
        }

        function onPlayerStateChange(event) {
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const overlay = document.getElementById('controls-overlay');
            
            if (event.data == YT.PlayerState.PLAYING) {
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                
                const videoContainer = document.getElementById('video-container');
                if (videoContainer && !videoContainer.matches(':hover')) {
                    resetTimer(false);
                } else {
                    overlay.classList.remove('controls-hidden', 'hide-cursor');
                    clearTimeout(hideTimeout);
                }
                
                // Update video title
                if (player && player.getVideoData) {
                    const videoData = player.getVideoData();
                    document.getElementById('current-video-title').innerText = videoData.title || 'Now Playing';
                }
            } else {
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                clearTimeout(hideTimeout);
                overlay.classList.remove('controls-hidden', 'hide-cursor');
            }
            
            if (event.data == YT.PlayerState.ENDED) {
                if (isPlaylist) {
                    // Mark current video as completed
                    updateVideoProgress(currentVideoId, 100, true);
                    
                    // Auto play next video
                    if (currentIndex < playlistItems.length - 1) {
                        setTimeout(() => {
                            nextVideo();
                        }, 1000);
                    }
                } else {
                    completeSession();
                }
            }
        }

        // --- Skip Functions ---
        
        function skipForward() {
            if (!player || typeof player.getCurrentTime !== 'function') return;
            const currentTime = player.getCurrentTime();
            const duration = player.getDuration();
            const newTime = Math.min(currentTime + 5, duration);
            player.seekTo(newTime, true);
            showSkipFeedback('forward', '+5s');
            resetTimer(true);
        }

        function skipBackward() {
            if (!player || typeof player.getCurrentTime !== 'function') return;
            const currentTime = player.getCurrentTime();
            const newTime = Math.max(currentTime - 5, 0);
            player.seekTo(newTime, true);
            showSkipFeedback('backward', '-5s');
            resetTimer(true);
        }

        function showSkipFeedback(direction, text) {
            const el = document.getElementById('skip-feedback');
            const icon = document.getElementById('skip-icon-path');
            const textEl = document.getElementById('skip-text');
            
            if (!el || !icon || !textEl) return;
            
            if (direction === 'forward') {
                icon.setAttribute('d', icons.skipForward);
            } else {
                icon.setAttribute('d', icons.skipBack);
            }
            
            textEl.innerText = text;
            el.style.opacity = '1';
            
            clearTimeout(window.skipFeedbackTimeout);
            window.skipFeedbackTimeout = setTimeout(() => {
                el.style.opacity = '0';
            }, 800);
        }

        // --- Touch Gesture Handlers ---

        function handleTouchStart(e) {
            touchStartX = e.changedTouches[0].screenX;
            if (e.target.closest('#controls-overlay')) {
                e.preventDefault();
            }
        }

        function handleTouchMove(e) {
            if (e.target.closest('#controls-overlay')) {
                e.preventDefault();
            }
        }

        function handleTouchEnd(e) {
            if (!player) return;
            
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
            
            const now = Date.now();
            if (now - lastTap < 300) {
                const touchX = e.changedTouches[0].clientX;
                const container = document.getElementById('video-container');
                if (container) {
                    const containerWidth = container.offsetWidth;
                    if (touchX < containerWidth / 2) {
                        skipBackward();
                    } else {
                        skipForward();
                    }
                }
            }
            lastTap = now;
            resetTimer(true);
        }

        function handleSwipe() {
            const swipeDistance = touchEndX - touchStartX;
            
            if (Math.abs(swipeDistance) > MIN_SWIPE_DISTANCE) {
                if (swipeDistance > 0) {
                    skipBackward();
                } else {
                    skipForward();
                }
            }
        }

        // --- Controls Logic ---

        function togglePlay() {
            if (!player || typeof player.getPlayerState !== 'function') return;
            const state = player.getPlayerState();
            if (state == YT.PlayerState.PLAYING) { 
                player.pauseVideo(); 
                showFeedback(icons.pause); 
            } else { 
                player.playVideo(); 
                showFeedback(icons.play); 
            }
            resetTimer(true); 
        }

        function toggleMute() {
            if (!player || typeof player.isMuted !== 'function') return;
            if (player.isMuted()) {
                player.unMute();
                document.getElementById('vol-icon').classList.remove('hidden');
                document.getElementById('mute-icon').classList.add('hidden');
                showFeedback(icons.vol);
            } else {
                player.mute();
                document.getElementById('vol-icon').classList.add('hidden');
                document.getElementById('mute-icon').classList.remove('hidden');
                showFeedback(icons.mute);
            }
            resetTimer(true);
        }

        function changeVolume(val) {
            if (!player || typeof player.setVolume !== 'function') return;
            player.setVolume(val);
            if (val == 0) {
                player.mute();
            } else {
                player.unMute();
            }
            resetTimer(true);
        }

        function changeSpeed(val) { 
            if (player && typeof player.setPlaybackRate === 'function') {
                player.setPlaybackRate(parseFloat(val)); 
            }
            resetTimer(true);
        }

        function toggleFullscreen() {
            const elem = document.getElementById('video-container');
            if (!document.fullscreenElement) {
                elem.requestFullscreen().catch(e => console.error(e));
            } else {
                document.exitFullscreen();
            }
            resetTimer(true);
        }

        document.addEventListener('keydown', (e) => {
            if (!player || document.getElementById('player-section').classList.contains('hidden')) return;
            
            if (e.code === 'ArrowLeft' || e.code === 'ArrowRight' || e.code === 'KeyN' || e.code === 'KeyP') {
                e.preventDefault();
            }
            
            switch(e.code) {
                case 'Space': 
                    e.preventDefault(); 
                    togglePlay(); 
                    break;
                case 'ArrowLeft': 
                    skipBackward(); 
                    break;
                case 'ArrowRight': 
                    skipForward(); 
                    break;
                case 'KeyM': 
                    toggleMute(); 
                    break;
                case 'KeyF': 
                    toggleFullscreen(); 
                    break;
                case 'KeyN': 
                    if (isPlaylist) nextVideo(); 
                    break;
                case 'KeyP': 
                    if (isPlaylist) previousVideo(); 
                    break;
            }
            resetTimer(true); 
        });

        function handleOverlayClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (e.target.closest('button') || 
                e.target.closest('select') || 
                e.target.closest('input')) {
                return;
            }
            
            const now = Date.now();
            if (now - lastTap < 300) {
                const clickX = e.clientX;
                const container = document.getElementById('video-container');
                if (container) {
                    const containerWidth = container.offsetWidth;
                    if (clickX < containerWidth / 2) {
                        skipBackward();
                    } else {
                        skipForward();
                    }
                }
            } else {
                togglePlay();
            }
            lastTap = now;
            resetTimer(true);
        }

        function showFeedback(path) {
            const el = document.getElementById('feedback-indicator');
            const icon = document.getElementById('feedback-icon');
            if(!icon) return;
            icon.innerHTML = `<path d="${path}"/>`;
            el.style.opacity = '1';
            setTimeout(() => el.style.opacity = '0', 500);
        }

        function startTracking() {
            if (progressInterval) clearInterval(progressInterval);
            progressInterval = setInterval(() => {
                if (player && typeof player.getDuration === 'function' && typeof player.getCurrentTime === 'function') {
                    const dur = player.getDuration();
                    const cur = player.getCurrentTime();
                    if (dur > 0) {
                        const percent = (cur / dur) * 100;
                        const progressPercent = Math.floor(percent);
                        
                        document.getElementById('progress-bar').style.width = percent + '%';
                        document.getElementById('percent-text').innerHTML = progressPercent + '% Complete';
                        
                        const format = (s) => {
                            const date = new Date(s * 1000);
                            const minutes = date.getUTCMinutes();
                            const seconds = date.getUTCSeconds();
                            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
                        };
                        document.getElementById('time-display').innerText = `${format(cur)} / ${format(dur)}`;
                        
                        // Save progress
                        if (!isComplete) {
                            localStorage.setItem(`video_progress_${currentVideoId}`, cur);
                            
                            // Update playlist progress
                            if (isPlaylist) {
                                const isCompleted = percent >= 95;
                                updateVideoProgress(currentVideoId, progressPercent, isCompleted);
                            }
                        }
                    }
                }
            }, 1000);
        }

        function completeSession() {
            isComplete = true;
            clearInterval(progressInterval);
            
            const btn = document.getElementById('close-btn');
            btn.disabled = false;
            btn.classList.remove('locked', 'bg-slate-700');
            btn.classList.add('bg-green-600', 'text-white');
            
            if (isPlaylist && playlistItems.length > 0) {
                btn.innerText = "Playlist Complete - Unlock";
                document.getElementById('status-text').innerHTML = "üîì Playlist Completed!";
            } else {
                btn.innerText = "Session Complete - Unlock";
                document.getElementById('status-text').innerHTML = "üîì Unlocked";
            }
            
            document.getElementById('status-text').classList.remove('text-slate-500');
            document.getElementById('status-text').classList.add('text-green-500');
            
            btn.onclick = () => {
                document.getElementById('success-modal').style.display = 'flex';
            };
        }

        function resetApp() {
            if (currentVideoId) {
                localStorage.removeItem(`video_progress_${currentVideoId}`);
            }
            if (playlistId) {
                localStorage.removeItem(`playlist_progress_${playlistId}`);
                localStorage.removeItem('active_playlist_id');
            }
            localStorage.removeItem('active_video_id');
            location.reload();
        }
    </script>
</body>
</html>
