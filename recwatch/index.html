<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focused Video Session - Integrated Controls</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .locked {
            cursor: not-allowed;
            opacity: 0.5;
        }
        #video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
            background: #000;
        }
        #player {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Disables direct interaction with iframe */
        }
        /* Floating Controls Overlay */
        #controls-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 20;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.2) 20%, transparent 40%);
            transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 1;
            pointer-events: auto; /* Ensure overlay can receive events */
        }
        #controls-overlay.hide-cursor {
            cursor: none;
        }
        .controls-hidden {
            opacity: 0 !important;
            pointer-events: none !important;
        }
        input[type="range"] {
            cursor: pointer;
        }
        /* Visual feedback for shortcuts */
        #feedback-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.5);
            border-radius: 50%;
            padding: 20px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 30;
        }
        /* Skip feedback indicator */
        #skip-feedback {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            font-size: 24px;
            font-weight: bold;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 35;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 2px solid rgba(59, 130, 246, 0.5);
        }
        /* Ensure buttons are clickable */
        #controls-overlay button,
        #controls-overlay select,
        #controls-overlay input[type="range"] {
            pointer-events: auto;
            position: relative;
            z-index: 25;
        }
        /* Touch zones for skip */
        .skip-zone {
            position: absolute;
            top: 0;
            width: 30%;
            height: 100%;
            z-index: 21;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            background: rgba(0,0,0,0.2);
        }
        #video-container:hover .skip-zone {
            opacity: 0.5;
        }
        .skip-zone:hover {
            opacity: 0.8 !important;
            background: rgba(0,0,0,0.4);
        }
        .skip-left {
            left: 0;
        }
        .skip-right {
            right: 0;
        }
        .skip-icon {
            background: rgba(0,0,0,0.6);
            border-radius: 50%;
            padding: 12px;
            color: white;
            border: 2px solid rgba(255,255,255,0.5);
        }
        /* Swipe indicator */
        .swipe-indicator {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            pointer-events: none;
            z-index: 36;
            border: 1px solid rgba(255,255,255,0.2);
        }
    </style>
</head>
<body class="bg-slate-900 min-h-screen flex flex-col items-center p-4 md:p-8 text-slate-100 transition-all">

    <div class="max-w-4xl w-full bg-slate-800 rounded-2xl shadow-2xl p-6 md:p-10 border border-slate-700">
        <!-- Header -->
        <div class="mb-6 text-center" id="header-area">
            <h1 class="text-2xl font-bold text-white mb-2">Focused Learning Portal</h1>
            <p id="sub-header" class="text-slate-400 text-sm">Session progress is automatically saved to your browser cache.</p>
        </div>

        <!-- Input Section -->
        <div id="setup-section" class="space-y-4">
            <div class="flex flex-col gap-2">
                <label for="video-url" class="font-semibold text-slate-300">Enter YouTube URL</label>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="video-url" placeholder="https://www.youtube.com/watch?v=..." 
                           class="flex-1 p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-white">
                    <button onclick="handleManualLoad()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-bold transition-all">
                        Load Session
                    </button>
                </div>
                <p id="error-msg" class="text-red-400 text-sm hidden">Invalid YouTube URL.</p>
            </div>
            <div class="text-xs text-slate-500 bg-slate-900/50 p-3 rounded border border-slate-700">
                <strong>Shortcuts:</strong> [Space] Play/Pause ‚Ä¢ [‚Üê] [‚Üí] Skip 5s ‚Ä¢ [M] Mute ‚Ä¢ [F] Fullscreen ‚Ä¢ [Double Tap Left/Right] Skip
            </div>
        </div>

        <!-- Integrated Video Section -->
        <div id="player-section" class="hidden space-y-6">
            <div id="video-container" class="rounded-xl overflow-hidden shadow-2xl border border-slate-700 group relative">
                <div id="player"></div>
                
                <!-- Skip Zones for Touch/Mouse -->
                <div class="skip-zone skip-left" onclick="skipBackward(); event.stopPropagation();" title="Skip Backward 5s">
                    <div class="skip-icon">
                        <svg class="w-8 h-8 fill-current" viewBox="0 0 24 24">
                            <path d="M11 18V6l-8.5 6 8.5 6zm.5-6l8.5 6V6l-8.5 6z"/>
                        </svg>
                    </div>
                </div>
                <div class="skip-zone skip-right" onclick="skipForward(); event.stopPropagation();" title="Skip Forward 5s">
                    <div class="skip-icon">
                        <svg class="w-8 h-8 fill-current" viewBox="0 0 24 24">
                            <path d="M13 6v12l8.5-6L13 6zm-1.5 6l-8.5 6V6l8.5 6z"/>
                        </svg>
                    </div>
                </div>
                
                <!-- Swipe Instruction (shows on mobile) -->
                <div class="swipe-indicator md:hidden">‚Üê Swipe Left/Right to Skip ‚Üí</div>
                
                <!-- Interaction & Controls Layer -->
                <div id="controls-overlay" 
                     onmouseenter="resetTimer(true)" 
                     onmousemove="resetTimer(false)" 
                     onmousedown="resetTimer(false)" 
                     onclick="handleOverlayClick(event)"
                     ontouchstart="handleTouchStart(event)"
                     ontouchmove="handleTouchMove(event)"
                     ontouchend="handleTouchEnd(event)">
                    
                    <!-- Feedback Center -->
                    <div id="feedback-indicator">
                        <svg id="feedback-icon" class="w-12 h-12 text-white fill-current" viewBox="0 0 24 24"></svg>
                    </div>
                    
                    <!-- Skip Feedback -->
                    <div id="skip-feedback">
                        <svg class="w-6 h-6 fill-current" viewBox="0 0 24 24">
                            <path id="skip-icon-path" d="M11 18V6l-8.5 6 8.5 6zm.5-6l8.5 6V6l-8.5 6z"/>
                        </svg>
                        <span id="skip-text">-5s</span>
                    </div>

                    <!-- Bottom Bar -->
                    <div class="p-4 w-full flex flex-col gap-3">
                        <!-- Progress Bar (Integrated) -->
                        <div class="relative w-full h-1.5 bg-white/20 rounded-full overflow-hidden">
                            <div id="progress-bar" class="absolute top-0 left-0 bg-blue-500 h-full w-0 transition-all duration-300"></div>
                        </div>

                        <div class="flex items-center justify-between">
                            <!-- Left: Play/Mute/Time -->
                            <div class="flex items-center gap-4">
                                <button onclick="togglePlay(); event.stopPropagation();" class="text-white hover:scale-110 transition-transform">
                                    <svg id="play-icon" class="w-7 h-7 fill-current" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                    <svg id="pause-icon" class="w-7 h-7 fill-current hidden" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                                </button>

                                <div class="flex items-center gap-2">
                                    <button onclick="toggleMute(); event.stopPropagation();" class="text-white/80 hover:text-white">
                                        <svg id="vol-icon" class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                                        <svg id="mute-icon" class="w-5 h-5 fill-current hidden" viewBox="0 0 24 24"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>
                                    </button>
                                    <input type="range" id="volume-slider" min="0" max="100" value="100" 
                                           oninput="changeVolume(this.value); event.stopPropagation();"
                                           class="w-16 h-1 bg-white/20 rounded-lg appearance-none accent-white">
                                </div>
                                <span id="time-display" class="text-[10px] font-mono text-white/60">0:00 / 0:00</span>
                            </div>

                            <!-- Center: Skip Buttons -->
                            <div class="flex items-center gap-2">
                                <button onclick="skipBackward(); event.stopPropagation();" class="text-white/80 hover:text-white bg-white/10 hover:bg-white/20 rounded-full p-2 transition-all">
                                    <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24">
                                        <path d="M11 18V6l-8.5 6 8.5 6zm.5-6l8.5 6V6l-8.5 6z"/>
                                    </svg>
                                </button>
                                <span class="text-xs text-white/60">5s</span>
                                <button onclick="skipForward(); event.stopPropagation();" class="text-white/80 hover:text-white bg-white/10 hover:bg-white/20 rounded-full p-2 transition-all">
                                    <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24">
                                        <path d="M13 6v12l8.5-6L13 6zm-1.5 6l-8.5 6V6l8.5 6z"/>
                                    </svg>
                                </button>
                            </div>

                            <!-- Right: Speed/FS -->
                            <div class="flex items-center gap-4">
                                <select id="speed-control" onchange="changeSpeed(this.value); event.stopPropagation();" 
                                        class="bg-transparent text-xs font-bold text-white border-none outline-none cursor-pointer">
                                    <option class="text-black" value="0.5">0.5x</option>
                                    <option class="text-black" value="1" selected>1.0x</option>
                                    <option class="text-black" value="1.5">1.5x</option>
                                    <option class="text-black" value="2.0">2.0x</option>
                                </select>
                                <button onclick="toggleFullscreen(); event.stopPropagation();" class="text-white/80 hover:text-white">
                                    <svg class="w-5 h-5 fill-current" viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lock Status -->
            <div class="flex flex-col items-center gap-4">
                <div class="flex justify-between w-full text-xs font-bold uppercase tracking-widest text-slate-500">
                    <span id="status-text">üîí Session Locked</span>
                    <span id="percent-text">0% Complete</span>
                </div>
                <button id="close-btn" disabled 
                        class="locked w-full py-4 bg-slate-700 text-slate-500 font-bold rounded-xl text-lg uppercase tracking-wider transition-all">
                    Complete Video to Unlock
                </button>
                <button onclick="resetApp()" class="text-xs text-slate-500 hover:text-slate-300 underline transition-colors">
                    Switch Video / Start New Session
                </button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 bg-slate-950/95 backdrop-blur-md hidden items-center justify-center p-4 z-50">
        <div class="bg-slate-800 p-8 rounded-2xl max-sm w-full text-center shadow-2xl border border-slate-700">
            <div class="w-20 h-20 bg-green-500/20 text-green-500 rounded-full flex items-center justify-center mx-auto mb-4 text-4xl">‚úì</div>
            <h2 class="text-2xl font-bold mb-2">Done!</h2>
            <p class="text-slate-400 mb-6 text-sm">Requirement met. Session cleared from cache.</p>
            <button onclick="resetApp()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold">Start New Session</button>
        </div>
    </div>

    <script>
        let player;
        let progressInterval;
        let isComplete = false;
        let hideTimeout;
        let lastTap = 0;
        let currentVideoId = "";
        
        // Touch gesture variables
        let touchStartX = 0;
        let touchEndX = 0;
        const MIN_SWIPE_DISTANCE = 50;

        const icons = {
            play: "M8 5v14l11-7z",
            pause: "M6 19h4V5H6v14zm8-14v14h4V5h-4z",
            mute: "M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z",
            vol: "M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z",
            skipBack: "M11 18V6l-8.5 6 8.5 6zm.5-6l8.5 6V6l-8.5 6z",
            skipForward: "M13 6v12l8.5-6L13 6zm-1.5 6l-8.5 6V6l8.5 6z"
        };

        // --- Core Lifecycle ---

        window.onload = function() {
            const lastSessionId = localStorage.getItem('active_video_id');
            if (lastSessionId) {
                loadVideo(lastSessionId);
            }
            
            // Add hover detection for the video container
            const videoContainer = document.getElementById('video-container');
            const overlay = document.getElementById('controls-overlay');
            
            if (videoContainer) {
                videoContainer.addEventListener('mouseenter', () => {
                    resetTimer(true); // true indicates manual hover
                });
                
                videoContainer.addEventListener('mouseleave', () => {
                    // Only hide if video is playing and mouse leaves the container
                    if (player && typeof player.getPlayerState === 'function') {
                        const state = player.getPlayerState();
                        if (state === YT.PlayerState.PLAYING) {
                            overlay.classList.add('controls-hidden', 'hide-cursor');
                        }
                    }
                });
            }
        };

        /**
         * resetTimer ensures the custom controls are visible whenever user activity is detected.
         * Activity includes mouse movement, clicking, or typing within the player scope.
         */
        function resetTimer(forceShow = false) {
            const overlay = document.getElementById('controls-overlay');
            if(!overlay) return;
            
            // Remove 'controls-hidden' and 'hide-cursor' classes to show the UI
            overlay.classList.remove('controls-hidden', 'hide-cursor');
            
            // Reset the auto-hide countdown
            clearTimeout(hideTimeout);
            
            // Only auto-hide if forceShow is false (not from forced hover) AND video is playing
            if (!forceShow) {
                if (player && typeof player.getPlayerState === 'function') {
                    const state = player.getPlayerState();
                    if (state === YT.PlayerState.PLAYING) {
                        hideTimeout = setTimeout(() => {
                            // Don't hide if mouse is still over the container
                            const videoContainer = document.getElementById('video-container');
                            if (videoContainer && !videoContainer.matches(':hover')) {
                                overlay.classList.add('controls-hidden', 'hide-cursor');
                            }
                        }, 3000);
                    }
                }
            }
        }

        window.onbeforeunload = () => (!isComplete && player && typeof player.getPlayerState === 'function') ? "Your progress is saved, but you haven't finished the video!" : null;

        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        function extractVideoId(url) {
            const match = url.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        function handleManualLoad() {
            const url = document.getElementById('video-url').value;
            const videoId = extractVideoId(url);
            if (!videoId) {
                document.getElementById('error-msg').classList.remove('hidden');
                return;
            }
            loadVideo(videoId);
        }

        function loadVideo(videoId) {
            currentVideoId = videoId;
            
            document.getElementById('setup-section').classList.add('hidden');
            document.getElementById('player-section').classList.remove('hidden');
            document.getElementById('sub-header').innerText = "Resuming your saved session...";

            const savedSeconds = localStorage.getItem(`video_progress_${currentVideoId}`) || 0;
            localStorage.setItem('active_video_id', currentVideoId);

            if (player && typeof player.loadVideoById === 'function') {
                player.loadVideoById({
                    videoId: videoId,
                    startSeconds: Math.floor(savedSeconds)
                });
            } else {
                player = new YT.Player('player', {
                    height: '360', width: '640', videoId: videoId,
                    playerVars: { 
                        'autoplay': 1, 'controls': 0, 'disablekb': 1, 'modestbranding': 1, 
                        'rel': 0, 'iv_load_policy': 3, 'fs': 0,
                        'start': Math.floor(savedSeconds)
                    },
                    events: { 
                        'onReady': onPlayerReady, 
                        'onStateChange': onPlayerStateChange 
                    }
                });
            }
        }

        function onPlayerReady() {
            startTracking();
            resetTimer(true); // Show controls on load
        }

        function onPlayerStateChange(event) {
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            const overlay = document.getElementById('controls-overlay');
            
            if (event.data == YT.PlayerState.PLAYING) {
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
                
                // Check if mouse is over container before auto-hiding
                const videoContainer = document.getElementById('video-container');
                if (videoContainer && !videoContainer.matches(':hover')) {
                    resetTimer(false); // Start hide timer if playing and mouse not hovering
                } else {
                    // If mouse is hovering, keep controls visible
                    overlay.classList.remove('controls-hidden', 'hide-cursor');
                    clearTimeout(hideTimeout);
                }
            } else {
                playIcon.classList.remove('hidden');
                pauseIcon.classList.add('hidden');
                // Ensure controls stay visible when paused
                clearTimeout(hideTimeout);
                overlay.classList.remove('controls-hidden', 'hide-cursor');
            }
            if (event.data == YT.PlayerState.ENDED) completeSession();
        }

        // --- Skip Functions ---
        
        function skipForward() {
            if (!player || typeof player.getCurrentTime !== 'function') return;
            const currentTime = player.getCurrentTime();
            const duration = player.getDuration();
            const newTime = Math.min(currentTime + 5, duration);
            player.seekTo(newTime, true);
            showSkipFeedback('forward', '+5s');
            resetTimer(true);
        }

        function skipBackward() {
            if (!player || typeof player.getCurrentTime !== 'function') return;
            const currentTime = player.getCurrentTime();
            const newTime = Math.max(currentTime - 5, 0);
            player.seekTo(newTime, true);
            showSkipFeedback('backward', '-5s');
            resetTimer(true);
        }

        function showSkipFeedback(direction, text) {
            const el = document.getElementById('skip-feedback');
            const icon = document.getElementById('skip-icon-path');
            const textEl = document.getElementById('skip-text');
            
            if (!el || !icon || !textEl) return;
            
            if (direction === 'forward') {
                icon.setAttribute('d', icons.skipForward);
            } else {
                icon.setAttribute('d', icons.skipBack);
            }
            
            textEl.innerText = text;
            el.style.opacity = '1';
            
            clearTimeout(window.skipFeedbackTimeout);
            window.skipFeedbackTimeout = setTimeout(() => {
                el.style.opacity = '0';
            }, 800);
        }

        // --- Touch Gesture Handlers ---

        function handleTouchStart(e) {
            touchStartX = e.changedTouches[0].screenX;
            // Prevent default to avoid page scroll while swiping on video
            if (e.target.closest('#controls-overlay')) {
                e.preventDefault();
            }
        }

        function handleTouchMove(e) {
            // Prevent default to avoid page scroll while swiping on video
            if (e.target.closest('#controls-overlay')) {
                e.preventDefault();
            }
        }

        function handleTouchEnd(e) {
            if (!player) return;
            
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
            
            // Check for double tap on touch devices
            const now = Date.now();
            if (now - lastTap < 300) {
                // Double tap detected - check position for skip direction
                const touchX = e.changedTouches[0].clientX;
                const container = document.getElementById('video-container');
                if (container) {
                    const containerWidth = container.offsetWidth;
                    if (touchX < containerWidth / 2) {
                        skipBackward();
                    } else {
                        skipForward();
                    }
                }
            }
            lastTap = now;
            
            resetTimer(true);
        }

        function handleSwipe() {
            const swipeDistance = touchEndX - touchStartX;
            
            if (Math.abs(swipeDistance) > MIN_SWIPE_DISTANCE) {
                if (swipeDistance > 0) {
                    // Swipe right - go backward
                    skipBackward();
                } else {
                    // Swipe left - go forward
                    skipForward();
                }
            }
        }

        // --- Controls Logic ---

        function togglePlay() {
            if (!player || typeof player.getPlayerState !== 'function') return;
            const state = player.getPlayerState();
            if (state == YT.PlayerState.PLAYING) { 
                player.pauseVideo(); 
                showFeedback(icons.pause); 
            } else { 
                player.playVideo(); 
                showFeedback(icons.play); 
            }
            resetTimer(true); 
        }

        function toggleMute() {
            if (!player || typeof player.isMuted !== 'function') return;
            if (player.isMuted()) {
                player.unMute();
                document.getElementById('vol-icon').classList.remove('hidden');
                document.getElementById('mute-icon').classList.add('hidden');
                showFeedback(icons.vol);
            } else {
                player.mute();
                document.getElementById('vol-icon').classList.add('hidden');
                document.getElementById('mute-icon').classList.remove('hidden');
                showFeedback(icons.mute);
            }
            resetTimer(true);
        }

        function changeVolume(val) {
            if (!player || typeof player.setVolume !== 'function') return;
            player.setVolume(val);
            if (val == 0) player.mute(); else player.unMute();
            resetTimer(true);
        }

        function changeSpeed(val) { 
            if (player && typeof player.setPlaybackRate === 'function') {
                player.setPlaybackRate(parseFloat(val)); 
            }
            resetTimer(true);
        }

        function toggleFullscreen() {
            const elem = document.getElementById('video-container');
            if (!document.fullscreenElement) elem.requestFullscreen().catch(e => console.error(e));
            else document.exitFullscreen();
            resetTimer(true);
        }

        document.addEventListener('keydown', (e) => {
            if (!player || document.getElementById('player-section').classList.contains('hidden')) return;
            
            // Prevent default behavior for arrow keys
            if (e.code === 'ArrowLeft' || e.code === 'ArrowRight') {
                e.preventDefault();
            }
            
            switch(e.code) {
                case 'Space': e.preventDefault(); togglePlay(); break;
                case 'ArrowLeft': skipBackward(); break;
                case 'ArrowRight': skipForward(); break;
                case 'KeyM': toggleMute(); break;
                case 'KeyF': toggleFullscreen(); break;
            }
            resetTimer(true); 
        });

        function handleOverlayClick(e) {
            // Prevent click from passing through to the iframe
            e.preventDefault();
            e.stopPropagation();
            
            // Don't toggle play if clicking on skip zones or buttons
            if (e.target.closest('.skip-zone') || 
                e.target.closest('button') || 
                e.target.closest('select') || 
                e.target.closest('input')) {
                return;
            }
            
            const now = Date.now();
            if (now - lastTap < 300) {
                // Double tap - check position for skip
                const clickX = e.clientX;
                const container = document.getElementById('video-container');
                if (container) {
                    const containerWidth = container.offsetWidth;
                    if (clickX < containerWidth / 2) {
                        skipBackward();
                    } else {
                        skipForward();
                    }
                }
            } else {
                togglePlay();
            }
            lastTap = now;
            resetTimer(true);
        }

        function showFeedback(path) {
            const el = document.getElementById('feedback-indicator');
            const icon = document.getElementById('feedback-icon');
            if(!icon) return;
            icon.innerHTML = `<path d="${path}"/>`;
            el.style.opacity = '1';
            setTimeout(() => el.style.opacity = '0', 500);
        }

        function startTracking() {
            if (progressInterval) clearInterval(progressInterval);
            progressInterval = setInterval(() => {
                if (player && typeof player.getDuration === 'function') {
                    const dur = player.getDuration();
                    const cur = player.getCurrentTime();
                    if (dur > 0) {
                        const percent = (cur / dur) * 100;
                        document.getElementById('progress-bar').style.width = percent + '%';
                        document.getElementById('percent-text').innerText = Math.floor(percent) + '% Complete';
                        const format = s => new Date(s * 1000).toISOString().substr(14, 5);
                        document.getElementById('time-display').innerText = `${format(cur)} / ${format(dur)}`;
                        if (!isComplete) {
                            localStorage.setItem(`video_progress_${currentVideoId}`, cur);
                        }
                    }
                }
            }, 1000);
        }

        function completeSession() {
            isComplete = true;
            clearInterval(progressInterval);
            
            const btn = document.getElementById('close-btn');
            btn.disabled = false;
            btn.classList.replace('bg-slate-700', 'bg-green-600');
            btn.classList.replace('text-slate-500', 'text-white');
            btn.classList.remove('locked');
            btn.innerText = "Session Complete - Unlock";
            document.getElementById('status-text').innerText = "üîì Unlocked";
            document.getElementById('status-text').classList.replace('text-slate-500', 'text-green-500');
            
            btn.onclick = () => {
                document.getElementById('success-modal').style.display = 'flex';
            };
        }

        function resetApp() {
            if (currentVideoId) {
                localStorage.removeItem(`video_progress_${currentVideoId}`);
            }
            localStorage.removeItem('active_video_id');
            location.reload();
        }
    </script>
</body>
</html>
